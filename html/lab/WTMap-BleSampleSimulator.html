<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-BleSampleSimulator</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="../wtmap/js/config-dev-2.5.1.js"></script>
    <link href="../wtmap/css/floor-switch.css" rel="stylesheet" type="text/css">

    <script src="../../dist/lab.js"></script>
    <script src="sample_helper.js"></script>
</head>
<body>

<div id='map'></div>

<script>
    console.log(wtmap.version);
    console.log(wtmap);
    var buildingID = "00270003";
    var sampleID = wtmap.Utils.getParameter("sampleID");
    var floor = wtmap.Utils.getParameter("floor");
    if (floor) floor = parseInt(floor);

    var use3D = true;
    use3D = false;

    var path = "/WTMapService/lab/GetSamplePbf?sampleID=" + sampleID;
    var http = new wtmap.HttpRequest();
    var simulator = new lab.Simulator();

    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        use3D: use3D,
        _disableCache: true,
        __disableGps: true,
        _debugBeacon: true,
        usePbf: true,
        sprite: "http://localhost:8112/WTMapResource/sprites/MilitaryGames",
        // sprite: "https://gis.cx9z.com/backend-map/sprites/MilitaryGames/MilitaryGamesSprite",
        // glyphs: "http://47.97.173.242:8080/WTMapResource/glyphs/{fontstack}/{range}.pbf"
    });

    map.on("click", function (evt) {
        console.log("Zoom: " + map.getZoom());
        console.log(evt.lngLat);
        console.log(wtmap.CoordProjection.lngLatToMercator(evt.lngLat.lng, evt.lngLat.lat));
        // stepPoints.push({lng: evt.lngLat.lng, lat: evt.lngLat.lat});
        // map.getSource("stepPoint").setData(geojson_utils.createPointFeatureCollection(stepPoints));
        // map.getSource("stepLine").setData(geojson_utils.createLineFeatureCollection([stepPoints]));
    });

    var sampleLayer = createSingleSampleLayer("sample");
    var gpsLayer = createSingleGpsLayer("gps");

    var mapStatus = {map: false, locator: false};
    map.on("mapready", function (evt) {
        // console.log("mapready");
        initFloorSwitch(map);

        sampleLayer.addToMap(map);
        gpsLayer.addToMap(map);

        mapStatus.map = true;
        getData();

        if (floor) map.setFloor(floor);
    });

    map.on("locator-ready", function () {
        console.log("locator-ready");
        mapStatus.ble = true;
        getData();
    });


    function getData() {
        if (!mapStatus.map || mapStatus.ble) return;
        http.requestBlobData(path, function (data) {
            var parser = new lab.WTBleSampleParser(data);
            showSample(parser.data);

            simulator.loadSimulationData(parser.toSimulatingData());
            simulator.start();
        }, function (error) {

        });
    }

    map.on("location-update", function (res) {
        console.log("location-update");
        console.log(res);
        map.showLocation(res.location);

        // var details = res.details;
        // var hint = "Source: " + res.source + "<br>";
        // hint += "Mode: " + details.mode + "<br>";
        // hint += "Target Mode: " + details.targetMode + "<br>";
        // hint += "Condition:<br> " + details.condition + "<br>";
        // hint += "X: " + round(res.location.x, 1) + ", Y: " + round(res.location.y, 1) + ", floor: " + res.location.floor + "<br>";
        // hint += "Gps: " + details.gpsValid + ", Ble: " + details.bleValid + "<br>";
        //
        // if (details.bleValid) {
        //     hint += "MaxRssi: " + details.maxRssi + ", Count: " + details.beaconCount + ", Index: " + details.index + "<br>";
        //     hint += "Avg: " + round(details.averageRssi, 2) + ", Avg2: " + round(details.averageRssi2, 2) + "<br>";
        // }
        // showHint(hint);
    });

    map.on("location-update-failed", function () {
        console.log("location-update-failed");
    });

    simulator.on("replay", function (event) {
        var replay = event.data;

        var index = replay.index;
        var data = replay.data;
        var value = data.value;
        var dataType = data.dataType;

        // console.log(dataType);
        if (dataType == lab.SimulationDataType.Gps) {
            // console.log("gps: " + index);
            // console.log(value);
            showGps(value);
        }

        if (dataType == lab.SimulationDataType.Ble) {
            // console.log("ble: " + index);
            // showBle(value.beacons);
            map.didRangeBeacons(value.beacons);
            // map.showLocation(res.location);
        }
    });

    function showBle(value) {
        // console.log("showBle");
        // console.log(value);
    }

    function showGps(value) {
        var lngLat = map._wtWgs84Converter.convertGPS(value);
        lngLat.properties = {
            timestamp: value.timestamp,
            accuracy: wtmap.Utils.round(value.accuracy, 2),
            index: value.index,
        };
        gpsLayer.showLabelData([lngLat]);
    }

    function showSample(sample) {
        var location = sample.location;
        var spArray = [];
        var lp = new wtmap.LocalPoint(location.x, location.y, location.floor);
        var lngLat = lp.toLngLatPoint();
        lngLat.properties = {
            timestamp: sample.timestamp,
            sampleID: sample.sampleID,
            ble: sample.bleList.length,
            gps: sample.gpsList.length,
            platform: sample.platform,
        };
        spArray.push(lngLat);
        sampleLayer.showLabelData(spArray);
    }

</script>

</body>
</html>
