<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-Sample</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="../wtmap/js/config-dev-2.5.1.js"></script>
    <link href="../wtmap/css/floor-switch.css" rel="stylesheet" type="text/css">

    <script src="../../dist/lab.js"></script>
</head>
<body>

<div id='map'></div>
<div class='floor-switch-overlay top'>
    <div class='floor-switch-overlay-inner'>
        <fieldset>
            <label>Select Floor</label>
            <select id='floorSwitch' name='floorSwitch'></select>
        </fieldset>
    </div>
</div>

<script>
    console.log(wtmap.version);
    console.log(wtmap);
    var buildingID = "00270003";
    var sampleID = wtmap.Utils.getParameter("sampleID");
    var use3D = true;
    use3D = false;

    // var path = "http://localhost:8112/WTMapService/lab/GetAllSamples?buildingID=" + buildingID;
    var path = "/WTMapService/lab/GetSamplePbf?sampleID=" + sampleID;
    var http = new wtmap.HttpRequest();

    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        use3D: use3D,
        _disableCache: true,
        __disableGps: true,
        usePbf: true,
        sprite: "http://localhost:8112/WTMapResource/sprites/MilitaryGames",
        // sprite: "https://gis.cx9z.com/backend-map/sprites/MilitaryGames/MilitaryGamesSprite",
        // glyphs: "http://47.97.173.242:8080/WTMapResource/glyphs/{fontstack}/{range}.pbf"
    });

    map.on("click", function (evt) {
        console.log("Zoom: " + map.getZoom());
        console.log(evt.lngLat);
        console.log(wtmap.CoordProjection.lngLatToMercator(evt.lngLat.lng, evt.lngLat.lat));
        // stepPoints.push({lng: evt.lngLat.lng, lat: evt.lngLat.lat});
        // map.getSource("stepPoint").setData(geojson_utils.createPointFeatureCollection(stepPoints));
        // map.getSource("stepLine").setData(geojson_utils.createLineFeatureCollection([stepPoints]));
    });


    var floorSwitch = document.getElementById('floorSwitch');
    floorSwitch.onchange = function () {
        map.setFloor(map.mapInfoArray[floorSwitch.selectedIndex].mapID);
    };

    var sampleLayer = new wtmap.CustomPointLabelLayer("sample");
    // sampleLayer.setTextProperty("user");
    // sampleLayer.setTextField(["get", "sampleID"]);
    var sampleText = ["concat", ["get", "sampleID"], "\nble(", ["get", "ble"], "), gps(", ["get", "gps"], ")"];
    sampleLayer.setTextField(sampleText);
    // sampleLayer.setTextColor("#ff0000");
    sampleLayer.setTextColor("#48d448");
    // sampleLayer.setTextSize(20);
    // sampleLayer.setCircleColor("#ff0000");
    sampleLayer.setCircleColor("#c4a000");
    sampleLayer.setCircleRadius(5);
    sampleLayer.setTextLayoutProperty("text-allow-overlap", true);

    var gpsLayer = new wtmap.CustomPointLabelLayer("gps");
    var gpsText = ["get", "index"];
    gpsLayer.setTextField(gpsText);
    gpsLayer.setTextColor("#000000");
    gpsLayer.setCircleRadius(3);
    // gpsLayer.setCircleColor("#00ff00");
    gpsLayer.setCircleColor("#00cccc");
    gpsLayer.setTextLayoutProperty("text-allow-overlap", true);

    map.on("mapready", function (evt) {
        // console.log("mapready");
        map.mapInfoArray.forEach(function (mapInfo) {
            var floorButton = document.createElement('option');
            floorButton.value = mapInfo.floorName;
            floorButton.text = mapInfo.floorName;
            floorSwitch.appendChild(floorButton);
            floorSwitch.selectedIndex = map.building.initFloorIndex;
        });
        console.log("initAngle: " + map.building.initAngle);

        sampleLayer.addToMap(map);
        gpsLayer.addToMap(map);

        getData();
    });

    function getData() {
        http.requestBlobData(path, function (data) {
            console.log("data");
            console.log(data);
            var parser = new lab.WTBleSampleParser(data);
            console.log(parser.data);

            var sample = parser.data;
            var location = sample.location;

            {
                var spArray = [];
                var lp = new wtmap.LocalPoint(location.x, location.y, location.floor);
                var lngLat = lp.toLngLatPoint();
                lngLat.properties = {
                    timestamp: sample.timestamp,
                    sampleID: sample.sampleID,
                    ble: sample.bleList.length,
                    gps: sample.gpsList.length,
                    platform: sample.platform,
                };
                spArray.push(lngLat);
                sampleLayer.showLabelData(spArray);
            }

            {
                var gpsArray = [];
                var gpsData = sample.gpsList;
                // console.log(gpsData);
                for (var i = 0; i < gpsData.length; ++i) {
                    var gps = gpsData[i];
                    var lngLat = map._wtWgs84Converter.convertGPS(gps);
                    lngLat.properties = {
                        timestamp: gps.timestamp,
                        accuracy: gps.accuracy,
                        index: i + 1,
                    };
                    gpsArray.push(lngLat);
                }
                gpsLayer.showLabelData(gpsArray);
            }
        }, function (error) {

        });
    }

</script>

</body>
</html>
