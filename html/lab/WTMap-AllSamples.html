<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-AllSamples</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="../wtmap/js/config-dev-2.5.1.js"></script>
    <link href="../wtmap/css/floor-switch.css" rel="stylesheet" type="text/css">

    <script src="sample_helper.js"></script>
</head>
<body>

<div id='map'></div>

<script>
    console.log(wtmap.version);
    console.log(wtmap);
    var buildingID = wtmap.Utils.getParameter("buildingID");
    buildingID = buildingID ? buildingID : "00270003";

    var useSimulator = !!wtmap.Utils.getParameter("simulator");

    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        // floorID: buildingID + "F03",
        use3D: false,
        _disableCache: true,
        __disableGps: true,
        usePbf: true,
        sprite: "http://localhost:8112/WTMapResource/sprites/MilitaryGames",
        // sprite: "https://gis.cx9z.com/backend-map/sprites/MilitaryGames/MilitaryGamesSprite",
        // glyphs: "http://47.97.173.242:8080/WTMapResource/glyphs/{fontstack}/{range}.pbf"
    });

    map.on("click", function (evt) {
        console.log("Zoom: " + map.getZoom());
        console.log(evt.lngLat);
        console.log(wtmap.CoordProjection.lngLatToMercator(evt.lngLat.lng, evt.lngLat.lat));

        var point = evt.point;
        var width = 10;
        var height = 20;

        var features = map.queryRenderedFeatures([
            [point.x - width / 2, point.y - height / 2],
            [point.x + width / 2, point.y + height / 2]
        ], {layers: [layer._getLayerID()]});
        console.log(features);
        if (features && features.length > 0) {
            var sampleID = features[0].properties.sampleID;
            var floor = features[0].properties.floor;
            var sampleUrl;
            if (useSimulator) {
                sampleUrl = getSampleSimulatorHtml(buildingID, sampleID, floor);
            } else {
                sampleUrl = getSampleDetailHtml(buildingID, sampleID, floor);
            }
            window.open(sampleUrl);
        }
    });

    var layer = createMultiSampleLayer("all-sample");

    map.on("mapready", function (evt) {
        console.log("mapready");
        initFloorSwitch(map);

        layer.addToMap(map);
        getData();
    });

    map.on("floorend", function (event) {
        layer.setFloor(event.mapInfo.floorNumber);
    });

    function getData() {
        http.requestData(getAllSampleUrl(buildingID), function (res) {
            console.log(res);
            var samplePoints = res.data.SamplePoints;
            var spArray = samplePointsToGeojson(samplePoints);
            layer.showLabelData(spArray);
        }, function (error) {
            console.log(error);
        });
    }

</script>

</body>
</html>
