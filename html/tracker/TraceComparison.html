<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trace-Comparison</title>

    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="../wtmap/js/config-dev-2.5.1.js"></script>
    <link href="../wtmap/css/floor-switch.css" rel="stylesheet" type="text/css">

    <script src="trace_helper.js"></script>
    <script src="trace_comparison.js"></script>
</head>
<body>

<div id='map'></div>

<script>
    console.log(wtmap.version);
    console.log(wtmap);
    var buildingID = wtmap.Utils.getParameter("buildingID");
    buildingID = buildingID ? buildingID : "05712001";

    var userID1 = wtmap.Utils.getParameter("userID1");
    userID1 = userID1 ? userID1 : "innerpeacer";

    var userID2 = wtmap.Utils.getParameter("userID2");
    userID2 = userID2 ? userID2 : "innerpeacer-2";

    var floor = wtmap.Utils.getParameter("floor");
    if (floor) floor = parseInt(floor);

    var http = new wtmap.HttpRequest();
    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        // use3D: false,
        use3D: true,
        _disableCache: true,
        maxZoom: 22,
        __disableGps: true,
        // _debugBeacon: true,
        usePbf: true,
        sprite: "http://localhost:8112/WTMapResource/sprites/MilitaryGames",
        // sprite: "https://gis.cx9z.com/backend-map/sprites/MilitaryGames/MilitaryGamesSprite",
        // glyphs: "http://47.97.173.242:8080/WTMapResource/glyphs/{fontstack}/{range}.pbf"
    });

    var data1;
    var data1Ready = false;
    var traceLayer1 = createTraceLayer("trace1");
    traceLayer1.setCirclePaintProperty("circle-color", "#a1a3a6");
    traceLayer1.setCirclePaintProperty("circle-radius", 8);
    var traceText = ["concat", "", ["get", "index"]];
    traceLayer1.setTextLayoutProperty("text-field", traceText);
    // traceLayer1.setTextLayoutProperty("text-field", "");
    traceLayer1.setTextLayoutProperty("text-offset", [0, -.6]);
    traceLayer1.setTextPaintProperty("text-color", "#ff0000");

    var data2;
    var data2Ready = false;
    var traceLayer2 = createTraceLayer("trace2");
    traceLayer2.setCirclePaintProperty("circle-color", "#f2eada");
    traceLayer2.setCirclePaintProperty("circle-radius", 6);
    var traceText2 = ["concat", "", ["get", "index"]];
    traceLayer2.setTextLayoutProperty("text-field", traceText2);
    // traceLayer2.setTextLayoutProperty("text-field", "");
    traceLayer2.setTextLayoutProperty("text-offset", [0, -.6]);
    traceLayer2.setTextPaintProperty("text-color", "#000000");

    var traceComparisionLayer = createTraceComparsionLayer("trace-comparision");
    traceComparisionLayer.setLineTextField(["get", "text"]);
    traceComparisionLayer.setLineColor(["get", "line-color"]);
    traceComparisionLayer.setLineTextColor(["get", "text-color"]);

    map.on("click", function (evt) {
        console.log("Zoom: " + map.getZoom());
        console.log(evt.lngLat);
    });


    function mouseMoveEvent(evt) {
        // console.log("mousemove");
        // console.log(traceLayer1.lineSymbolLayerID);
        // console.log(evt);

        var features = map.queryRenderedFeatures(evt.point, {layers: [traceLayer1.tracePointCircleLayerID]})
        // console.log("features");
        // console.log(features);
        if (features.length > 0) {
            console.log(features[0].properties)
            var selectedIndex = features[0].properties.index;
            console.log(selectedIndex);
            updateTraceComparisionData(selectedIndex);
        }
    }

    function updateTraceComparisionData(index) {
        console.log("updateTraceComparisionData")
        // comparisionData[index].properties["line-color"] = "#ff0000";
        // comparisionData[index].properties["text-color"] = "#ff0000";
        // comparisionData[index].properties["visible"] = true;

        for (var i in comparisionData) {
            var np = comparisionData[i];
            if (np.properties.srcIndex == index) {
                np.properties["line-color"] = "#ff0000";
                np.properties["text-color"] = "#ff0000";
                np.properties["visible"] = true;
            } else {
                np.properties["visible"] = false;
            }
            // console.log(comparisionData[i]);
        }

        traceComparisionLayer.showLineData(comparisionData);
    }

    map.on("mapready", function (evt) {
        // console.log("mapready");
        initFloorSwitch(map);

        traceLayer2.addToMap(map);
        traceLayer1.addToMap(map);

        traceComparisionLayer.addToMap(map);
        map.setFilter(traceComparisionLayer.lineSymbolLayerID, ['==', ['get', 'visible'], true]);
        map.setFilter(traceComparisionLayer.lineLayerID, ['==', ['get', 'visible'], true]);

        if (floor) map.setFloor(floor);

        getData();

        map.on("mousemove", mouseMoveEvent);
    });

    function getData() {
        // console.log("getData");

        http.requestData(getQueryTraceUrl(userID1), function (res) {
            data1 = res.data.points;
            data1Ready = true;
            traceLayer1.showTraceData(tracePointsToGeojson(res.data.points));
            processData();
        });

        // http.requestData(getQueryTraceUrl(userID1, true), function (res) {
        http.requestData(getQueryTraceUrl(userID2), function (res) {
            data2 = res.data.points;
            data2Ready = true;
            traceLayer2.showTraceData(tracePointsToGeojson(res.data.points));

            traceComparisionLayer.showLineData([tracePointsToGeojson(res.data.points)])

            processData();
        });
    }

    var comparisionData = [];

    function processData() {
        if (!data1Ready || !data2Ready) return;

        console.log("processData");
        console.log(data1);
        console.log(data2);

        // for (var i = 0; i < data1.length; ++i) {
        //     console.log(data1[i]);
        // }

        var res1 = analyzeTracePoint(data1);
        // console.log(res1);

        var res2 = analyzeTracePoint(data2);
        // console.log(res2);

        // var np = findNearestPoint(res1.pointMap[10], res2);
        // console.log("NearestPoint");
        // console.log(np);

        for (var i1 in res1.pointMap) {
            var p1 = res1.pointMap[i1];
            var np1 = findNearestPoint(p1, res2);
            if (np1 != null) {
                console.log("Nearest: " + i1);
                console.log(np1);

                var segment = [];
                segment.push(new wtmap.LocalPoint(p1.x, p1.y, p1.floor).getLngLat());

                var p2 = res2.pointMap[np1.index];
                segment.push(new wtmap.LocalPoint(p2.x, p2.y, p2.floor).getLngLat());

                segment.properties = {
                    srcIndex: i1,
                    destIndex: np1.index,
                    distance: np1.nearestDistance,
                    deltaTime: np1.deltaTime,
                    text: "距离：" + np1.nearestDistance + "m，时间差：" + np1.deltaTime + "s",
                    "line-color": "#888888",
                    "text-color": "#888888",
                    visible: false,
                };
                comparisionData.push(segment);
            }
        }

        comparisionData.sort(function (s1, s2) {
            return s1.properties.distance - s2.properties.distance;
        });
        console.log(comparisionData[0].properties.distance);
        console.log(comparisionData[1].properties.distance);
        comparisionData[0].properties["line-color"] = "#ff0000";
        comparisionData[0].properties["text-color"] = "#ff0000";
        comparisionData[0].properties["visible"] = true;

        traceComparisionLayer.showLineData(comparisionData);
        console.log(traceComparisionLayer.lineSymbolLayerID);
        console.log(traceComparisionLayer.lineLayerID);
        console.log(traceLayer1.tracePointCircleLayerID);
    }

</script>

</body>
</html>