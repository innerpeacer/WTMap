<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-2.5.1-Route</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>

    <script src="js/config-dev-2.5.1.js"></script>
    <link href="./css/floor-switch.css" rel="stylesheet" type="text/css">
    <script src="MultiRouteHelper.js"></script>

</head>
<body>

<div id='map'></div>
<div class='floor-switch-overlay top'>
    <div class='floor-switch-overlay-inner'>
        <fieldset>
            <label>Select Floor</label>
            <select id='floorSwitch' name='floorSwitch'></select>
        </fieldset>
    </div>
</div>

<script>
    var host = window.location.protocol + "//" + window.location.host;
    var buildingID = getParameter("buildingID");
    if (buildingID == null) buildingID = "00270003";

    var startPoint, endPoint, stopPoints = [];
    startPoint = {
        x: 12738295.864284057,
        y: 3582540.92400937,
//        lng: 114.26124926383198,
//        lat: 30.62606903794945,
        floor: 1
    };
    startPoint.lng = wtmap.CoordProjection.mercatorToLngLat(startPoint.x, startPoint.y).lng;
    startPoint.lat = wtmap.CoordProjection.mercatorToLngLat(startPoint.x, startPoint.y).lat;

    endPoint = {
        x: 12738441.504142517,
        y: 3582621.2797355605,
//        lng: 114.26163100882661,
//        lat: 30.62590826008615,
        floor: 1
    };
    endPoint.lng = wtmap.CoordProjection.mercatorToLngLat(endPoint.x, endPoint.y).lng;
    endPoint.lat = wtmap.CoordProjection.mercatorToLngLat(endPoint.x, endPoint.y).lat;

    var currentPoint;
    var locationPoint;

    console.log(wtmap.WTMap);
    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
//        use3D: false,
        floorID: "00270003F01",
        sprite: host + "/WTMapResource/sprites/MilitaryGames",
        glyphs: host + "/WTMapResource/glyphs/{fontstack}/{range}.pbf",
    });
    console.log(map);

    map.showTileBoundaries = true;
    map.on("click", function (evt) {
        console.log("Zoom: " + map.getZoom());
//        console.log("Bounds: "+  map.getBounds());
        console.log(evt.lngLat.lat);

        var lngLat = evt.lngLat;
        var p = wtmap.CoordProjection.lngLatToMercator(lngLat.lng, lngLat.lat);
        currentPoint = {x: p.x, y: p.y, lng: lngLat.lng, lat: lngLat.lat, floor: map.currentMapInfo.floorNumber};
        console.log(currentPoint);

        popup.setLngLat(lngLat);
        popup.addTo(map);
        map.getSource("hint").setData(createStartEndData(currentPoint));
    });

    map.on("mapready", function (evt) {
        console.log("mapready");
        map.mapInfoArray.forEach(function (mapInfo) {
            var floorButton = document.createElement('option');
            floorButton.value = mapInfo.floorName;
            floorButton.text = mapInfo.floorName;
            floorSwitch.appendChild(floorButton);
        });

        initLayers(map);
        showParams();
    });

    var floorSwitch = document.getElementById('floorSwitch');
    floorSwitch.onchange = function () {
        map.setFloor(map.mapInfoArray[floorSwitch.selectedIndex].mapID);
    };

    map.on("error", function (error) {
        console.log("map-error");
        console.log(error)
    });

    function setStart() {
        console.log("setStart");
        startPoint = currentPoint;
        showParams();
    }

    function setEnd() {
        console.log("setEnd");
        endPoint = currentPoint;
        showParams();
    }

    function addStop() {
        console.log("addStop");
        stopPoints.push(currentPoint);
        showParams();
    }

    function resetStops() {
        console.log("resetStops");
        stopPoints = [];
        showParams();
    }

    function requestRoute() {
        showParams();

        map.requestRoute(startPoint, endPoint, stopPoints, function (routeResult) {
            console.log(routeResult);
            map.showRoute();
        }, function (error) {
            console.log("route error callback");
            console.log(error);
        }, {
//            rearrangeStops: false,
//            version: "V2",
//            vehicle: true,        // 车行路线
//            ignore: ["150014"] // 忽略扶梯
//            ignore: ["150013"]  // 忽略直梯
            sameFloorFirst: false
        });
    }

    var status000 = false;

    function hideRoute() {
        console.log("hideRoute");
        status000 = false;
        map.hideRoute();
    }

    function simulateLocation0() {
        console.log("simulateLocation0");
        locationPoint = {x: currentPoint.lng, y: currentPoint.lat, floor: currentPoint.floor};
        map.showRoute(locationPoint);
    }

    function simulateLocation1() {
        console.log("simulateLocation1");
        locationPoint = {x: currentPoint.lng, y: currentPoint.lat, floor: currentPoint.floor};
        map.showRoute(locationPoint, 1);
    }

    function simulateLocation2() {
        console.log("simulateLocation2");
        locationPoint = {x: currentPoint.lng, y: currentPoint.lat, floor: currentPoint.floor};
        map.showRoute(locationPoint, 2);
    }


    var popupHtml = '<button onclick="setStart()" type="button">设为起点</button>' +
        '<button onclick="setEnd()" type="button">设为终点</button>' +
        '<button onclick="addStop()" type="button">添加途经点</button><br>' +
        '<button onclick="requestRoute()" type="button">请求路径</button>' +
        '<button onclick="hideRoute()" type="button">隐藏路径</button>' +
        '<button onclick="resetStops()" type="button">重置路经点</button><br>' +
        '<button onclick="simulateLocation0()" type="button">模拟定位点(第1段)</button>' +
        '<button onclick="simulateLocation1()" type="button">模拟定位点(第2段)</button>' +
        '<button onclick="simulateLocation2()" type="button">模拟定位点(第3段)</button>';

    var popup = new wtmap.Popup({closeOnClick: false, offset: {'bottom': [0, -10]}})
        .setHTML(popupHtml);
    popup.addTo(map);

    function showParams() {
        map.getSource("params").setData(createParamData(stopPoints));
        map.getSource("startEnd").setData(createStartEndData(startPoint, endPoint));
    }

</script>

</body>
</html>
