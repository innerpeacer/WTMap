<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-Locator</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="js/config-dev-2.5.1.js"></script>
    <link href="./css/floor-switch.css" rel="stylesheet" type="text/css">
    <script src="vconsole.min.js"></script>
</head>
<body>

<style>
    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 100px;
        top: 0;
        right: 0;
        padding: 10px;
    }
</style>

<div id='map'></div>
<div class='floor-switch-overlay top'>
    <div class='floor-switch-overlay-inner'>
        <fieldset>
            <label>Select Floor</label>
            <select id='floorSwitch' name='floorSwitch'></select>
        </fieldset>
    </div>
</div>

<div id='data'>
    <div class='map-overlay'>
        <label id="hint"></label>
    </div>
</div>

<script>
    var hintLabel = document.getElementById("hint");
    new VConsole();
    console.log(wtmap.version);
    var buildingID = getParameter("buildingID");
    if (buildingID == null) buildingID = "00278888";
    var use3D = true;
    use3D = false;

    var currentLocation;
    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        use3D: use3D,
        _disableCache: true,
        _dataVersion: "v5",
        usePbf: true,
        _debugBeacon: true,
        enableOrientation: true,
        enableMotion: true
    });
    // map.showTileBoundaries = true;
    // map.showCollisionBoxes = true;

    map.on("click", function (evt) {
        // console.log("Zoom: " + map.getZoom());
        console.log(evt.lngLat);
        console.log(map.building.initAngle);
    });

    var currentHeading = null;
    map.on("heading", function (evt) {
        if (!map.currentMapInfo || !map.currentMapInfo.floorNumber) return;
        currentHeading = evt.heading || 0;
        map.showLocation(currentLocation, {
            center: true,
            angle: currentHeading - map.building.initAngle
        });
    });

    map.on("motion", function (evt) {
        // console.log(evt);
        // hintLabel.innerHTML = eventToString(evt);
    });

    var floorSwitch = document.getElementById('floorSwitch');
    floorSwitch.onchange = function () {
        map.setFloor(map.mapInfoArray[floorSwitch.selectedIndex].mapID);
    };

    map.on("mapready", function (evt) {
        console.log("mapready");
        map.mapInfoArray.forEach(function (mapInfo) {
            var floorButton = document.createElement('option');
            floorButton.value = mapInfo.floorName;
            floorButton.text = mapInfo.floorName;
            floorSwitch.appendChild(floorButton);
            floorSwitch.selectedIndex = map.building.initFloorIndex;
        });
    });

    map.on("floorend", function (evt) {
        // console.log(evt.mapInfo);
        for (var i = 0; i < map.mapInfoArray.length; ++i) {
            var info = map.mapInfoArray[i];
            if (info.floorNumber == evt.mapInfo.floorNumber) {
                floorSwitch.selectedIndex = i;
                return;
            }
        }
    });

    map.on("wheel", function () {
//        console.log("wheel");
    });

    map.on("error", function (error) {
        console.log("map-error");
        console.log(error)
    });

    map.on("locator-ready", function () {
        // console.log("locator-ready");
        let beaconInfo = map._locator._biteMe("_getBeaconInfo");
        if (beaconInfo) {
            console.log(beaconInfo.uuid);
            console.log(beaconInfo.major);
            console.log(beaconInfo.minor);
        }
    });

    // ------ reactive with native ------------
    function nativeToJs() {
        console.log("nativeToJs called");
        map.panBy([50, 50]);
        return "nativeToJs called";
    }

    function jsToNative(obj) {
        if (window.webkit) {
            window.webkit.messageHandlers.jsToNative.postMessage(obj);
        }
    }

    function scan(data) {
        console.log("scan called");
        console.log(data);

        var res = map.didRangeBeacons(data);
        if (res && res.location) {
            currentLocation = {x: res.location.x, y: res.location.y, floor: res.location.floor};
            console.log(currentLocation);
            map.showLocation(currentLocation, {
                center: map.currentMapInfo.floorNumber !== currentLocation.floor,
                angle: currentHeading - map.building.initAngle
            });
            return res;
        }
        console.log("no location");
        return "no location";
    }

    function watchGPS() {
        console.log("watchGPS");
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(gpsLocation);
        } else {
            hintLabel.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function getGPS() {
        console.log("getGPS");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(gpsLocation);
        } else {
            hintLabel.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    var index = 0

    function gpsLocation(position) {
        // console.log("gpsLocation");
        hintLabel.innerHTML = "Index: " + index++ + "<br />Latitude: " + position.coords.latitude +
            "<br />Longitude: " + position.coords.longitude;

        var gps = {
            lng: position.coords.longitude,
            lat: position.coords.latitude
        };

        var converted = map._wtWgs84Converter.convertGPS(gps);
        converted.floor = map.currentMapInfo.floorNumber;
        currentLocation = converted;
        map.showLocation(converted, {
            center: true,
            angle: currentHeading - map.building.initAngle
        });
    }

    watchGPS();
    // getGPS();

</script>

</body>
</html>
