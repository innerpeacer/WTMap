<html>
<head>
    <meta charset='utf-8'/>
    <title>WTMap-Locator</title>
    <meta content='initial-scale=1,maximum-scale=1,user-scalable=no' name='viewport'/>
    <script src="js/config-dev-2.5.1.js"></script>
    <link href="./css/floor-switch.css" rel="stylesheet" type="text/css">

</head>
<body>

<div id='map'></div>
<div class='floor-switch-overlay top'>
    <div class='floor-switch-overlay-inner'>
        <fieldset>
            <label>Select Floor</label>
            <select id='floorSwitch' name='floorSwitch'></select>
        </fieldset>
    </div>
</div>

<script>
    console.log(wtmap.version);
    var host = "http://" + window.location.host;
    var buildingID = "00270003";
    var use3D = true;
    use3D = false;

    var map = new wtmap.WTMap({
        container: 'map',
        buildingID: buildingID,
        use3D: use3D,
        _disableCache: true,
        _dataVersion: "v5",
        usePbf: true,
        _debugBeacon: true,
        sprite: host + "/WTMapResource/sprites/MilitaryGames",
        glyphs: host + "/WTMapResource/glyphs/{fontstack}/{range}.pbf",
        _apiHost: host
    });
    // map.showTileBoundaries = true;
    // map.showCollisionBoxes = true;

    map.on("click", function (evt) {
        // console.log("Zoom: " + map.getZoom());
        // console.log(evt.lngLat);
        var beaconArray = map._locator._biteMe("_getLocatingBeaconArray");
        // console.log(beaconArray);
        if (!beaconArray) return;
        var length = beaconArray.length;
        var beacon = beaconArray[parseInt(Math.random() * (length - 1))];
        // console.log(beacon);
        if (!beacon) return;

        var beacons = [{
            "uuid": "FDA50693-A4E2-4FB1-AFCF-C6EB07647825",
            "major": 10180,
            "minor": beacon.minor,
            // "minor": 30897,
            "rssi": -70,
            "accuracy": 1.4534
        }];

        var res = map.didRangeBeacons(beacons);
        if (res == null) return;

        var location = {x: res.location.x, y: res.location.y, floor: res.location.floor};
        map.setZoom(19);
        map.showLocation(location, {center: true});
        // console.log(res);
    });

    var floorSwitch = document.getElementById('floorSwitch');
    floorSwitch.onchange = function () {
        map.setFloor(map.mapInfoArray[floorSwitch.selectedIndex].mapID);
    };

    map.on("mapready", function (evt) {
        // console.log("mapready");
        // console.log("BaseZoom: " + map.getBaseZoom());

        map.mapInfoArray.forEach(function (mapInfo) {
            var floorButton = document.createElement('option');
            floorButton.value = mapInfo.floorName;
            floorButton.text = mapInfo.floorName;
            floorSwitch.appendChild(floorButton);
            floorSwitch.selectedIndex = map.building.initFloorIndex;
        });
    });

    map.on("floorend", function (evt) {
        // console.log(evt.mapInfo);
        for (var i = 0; i < map.mapInfoArray.length; ++i) {
            var info = map.mapInfoArray[i];
            if (info.floorNumber == evt.mapInfo.floorNumber) {
                floorSwitch.selectedIndex = i;
                map.fire('click');
                return;
            }
        }
    });

    map.on("wheel", function () {
//        console.log("wheel");
    });

    map.on("error", function (error) {
        console.log("map-error");
        console.log(error)
    });

    map.on("locator-ready", function () {
        // console.log("locator-ready");
    });

</script>

</body>
</html>
